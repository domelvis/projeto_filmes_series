{% extends 'base.html' %}

{% block title %}Séries - Series & Filmes{% endblock %}

{% block content %}
<!-- Filtros e Busca -->
<div class="mb-8">
    <div class="bg-white rounded-lg shadow p-6">
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Busca -->
            <div class="md:col-span-2">
                <label for="search" class="form-label">Buscar</label>
                <div class="relative">
                    <input type="text" 
                           id="search" 
                           name="search" 
                           value="{{ request.GET.search }}"
                           placeholder="Buscar séries..." 
                           class="form-input pl-10">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            
            <!-- Gênero -->
            <div>
                <label for="genre" class="form-label">Gênero</label>
                <select id="genre" name="genre" class="form-input">
                    <option value="">Todos</option>
                    {% for genre in genres %}
                        <option value="{{ genre.id }}" {% if request.GET.genre == genre.id|stringformat:"s" %}selected{% endif %}>
                            {{ genre.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Ordenação -->
            <div>
                <label for="sort" class="form-label">Ordenar por</label>
                <select id="sort" name="sort" class="form-input">
                    <option value="title" {% if request.GET.sort == 'title' %}selected{% endif %}>Título</option>
                    <option value="-rating" {% if request.GET.sort == '-rating' %}selected{% endif %}>Maior Avaliação</option>
                    <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>Mais Recentes</option>
                    <option value="-views" {% if request.GET.sort == '-views' %}selected{% endif %}>Mais Populares</option>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Séries -->
<div class="series-grid">
    {% for series in series_list %}
    <div class="series-card group">
        <!-- Poster -->
        <div class="relative overflow-hidden">
            <img src="{{ series.poster_url }}" 
                 alt="{{ series.title }}"
                 class="w-full h-64 object-cover transform group-hover:scale-105 transition-transform duration-300">
            
            <!-- Overlay com ações -->
            <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center space-x-4">
                <a href="{% url 'series:detail' series.id %}" 
                   class="bg-white text-gray-900 rounded-full p-2 hover:bg-gray-100 transition-colors"
                   title="Ver detalhes">
                    <i class="fas fa-eye"></i>
                </a>
                <button class="bg-white text-gray-900 rounded-full p-2 hover:bg-gray-100 transition-colors"
                        data-favorite="{{ series.id }}"
                        title="{% if series.is_favorite %}Remover dos favoritos{% else %}Adicionar aos favoritos{% endif %}">
                    <i class="{% if series.is_favorite %}fas{% else %}far{% endif %} fa-heart {% if series.is_favorite %}text-red-500{% endif %}"></i>
                </button>
            </div>
        </div>
        
        <!-- Conteúdo -->
        <div class="p-4">
            <h3 class="text-lg font-semibold mb-2">{{ series.title }}</h3>
            
            <!-- Gêneros -->
            <div class="mb-3 flex flex-wrap gap-2">
                {% for genre in series.genres.all %}
                    <span class="badge badge-secondary">{{ genre.name }}</span>
                {% endfor %}
            </div>
            
            <!-- Avaliação -->
            <div class="flex items-center space-x-2 mb-3">
                <div class="rating" data-rating="{{ series.rating }}">
                    {% for i in "12345" %}
                        <i class="fas fa-star {% if forloop.counter <= series.rating %}text-yellow-400{% else %}text-gray-300{% endif %}"></i>
                    {% endfor %}
                </div>
                <span class="text-sm text-gray-600">({{ series.total_ratings }})</span>
            </div>
            
            <!-- Descrição -->
            <p class="text-sm text-gray-600 mb-4 line-clamp-2">{{ series.description }}</p>
            
            <!-- Informações adicionais -->
            <div class="flex justify-between text-sm text-gray-500">
                <span>
                    <i class="fas fa-calendar-alt mr-1"></i>{{ series.year }}
                </span>
                <span>
                    <i class="fas fa-clock mr-1"></i>{{ series.episodes }} episódios
                </span>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center py-12">
        <div class="text-6xl mb-4 text-gray-300">
            <i class="fas fa-tv"></i>
        </div>
        <h3 class="text-xl font-semibold mb-2">Nenhuma série encontrada</h3>
        <p class="text-gray-600">
            Tente ajustar seus filtros ou fazer uma nova busca.
        </p>
    </div>
    {% endfor %}
</div>

<!-- Paginação -->
{% if is_paginated %}
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}"
           class="page-item">
            <i class="fas fa-chevron-left"></i>
        </a>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
            <span class="page-item active">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}"
               class="page-item">
                {{ num }}
            </a>
        {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}"
           class="page-item">
            <i class="fas fa-chevron-right"></i>
        </a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Atualizar formulário automaticamente quando filtros mudarem
document.querySelectorAll('select[name="genre"], select[name="sort"]').forEach(select => {
    select.addEventListener('change', () => {
        select.closest('form').submit();
    });
});

// Busca com debounce
const searchInput = document.querySelector('input[name="search"]');
let debounceTimer;

searchInput.addEventListener('input', e => {
    clearTimeout(debounceTimer);
    
    debounceTimer = setTimeout(() => {
        e.target.closest('form').submit();
    }, 500);
});
</script>
{% endblock %}