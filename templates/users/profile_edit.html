{% extends 'base.html' %}

{% block title %}Editar Perfil - {{ user.get_full_name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <!-- Cabeçalho -->
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">
                Editar Perfil
            </h2>
            <p class="mt-2 text-sm text-gray-600">
                Atualize suas informações pessoais e preferências
            </p>
        </div>

        <!-- Formulário -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <form method="post" action="{% url 'users:profile_edit' %}" enctype="multipart/form-data" class="space-y-8 p-6">
                {% csrf_token %}

                <!-- Foto do Perfil -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        Foto do Perfil
                    </label>
                    <div class="mt-2 flex items-center space-x-5">
                        <div class="flex-shrink-0">
                            {% if user.profile_image %}
                                <img class="h-16 w-16 rounded-full" src="{{ user.profile_image.url }}" alt="{{ user.get_full_name }}">
                            {% else %}
                                <span class="h-16 w-16 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center">
                                    <i class="fas fa-user text-3xl text-gray-400"></i>
                                </span>
                            {% endif %}
                        </div>
                        <div>
                            <label for="profile_image" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                <span>Alterar</span>
                                <input type="file" id="profile_image" name="profile_image" class="sr-only" accept="image/*">
                            </label>
                            <button type="button" id="remove_image" class="ml-3 bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-red-600 hover:text-red-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                Remover
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Nome e Sobrenome -->
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                    <div>
                        <label for="first_name" class="block text-sm font-medium text-gray-700">
                            Nome
                        </label>
                        <div class="mt-1">
                            <input type="text" 
                                   name="first_name" 
                                   id="first_name" 
                                   value="{{ user.first_name }}"
                                   class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div>
                        <label for="last_name" class="block text-sm font-medium text-gray-700">
                            Sobrenome
                        </label>
                        <div class="mt-1">
                            <input type="text" 
                                   name="last_name" 
                                   id="last_name" 
                                   value="{{ user.last_name }}"
                                   class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>

                <!-- Username e Email -->
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">
                            Nome de usuário
                        </label>
                        <div class="mt-1">
                            <input type="text" 
                                   name="username" 
                                   id="username" 
                                   value="{{ user.username }}"
                                   class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">
                            E-mail
                        </label>
                        <div class="mt-1">
                            <input type="email" 
                                   name="email" 
                                   id="email" 
                                   value="{{ user.email }}"
                                   class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>

                <!-- Bio -->
                <div>
                    <label for="bio" class="block text-sm font-medium text-gray-700">
                        Biografia
                    </label>
                    <div class="mt-1">
                        <textarea id="bio" 
                                  name="bio" 
                                  rows="3"
                                  class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md">{{ user.bio }}</textarea>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">
                        Escreva um pouco sobre você. Máximo 500 caracteres.
                    </p>
                </div>

                <!-- Preferências -->
                <fieldset>
                    <legend class="text-base font-medium text-gray-900">
                        Preferências de Notificação
                    </legend>
                    <div class="mt-4 space-y-4">
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="email_notifications" 
                                       name="email_notifications" 
                                       type="checkbox"
                                       {% if user.email_notifications %}checked{% endif %}
                                       class="focus:ring-primary h-4 w-4 text-primary border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="email_notifications" class="font-medium text-gray-700">
                                    Notificações por E-mail
                                </label>
                                <p class="text-gray-500">
                                    Receba atualizações sobre suas séries favoritas e novidades.
                                </p>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- Botões -->
                <div class="flex justify-end space-x-3">
                    <a href="{% url 'users:profile' %}" 
                       class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Cancelar
                    </a>
                    <button type="submit" 
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Salvar Alterações
                    </button>
                </div>
            </form>

            <!-- Alteração de Senha -->
            <div class="border-t border-gray-200 mt-8 pt-8 px-6 pb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    Alterar Senha
                </h3>
                <form method="post" action="{% url 'users:change_password' %}" class="space-y-6">
                    {% csrf_token %}

                    <div class="space-y-4">
                        <!-- Senha Atual -->
                        <div>
                            <label for="current_password" class="block text-sm font-medium text-gray-700">
                                Senha Atual
                            </label>
                            <div class="mt-1">
                                <input type="password" 
                                       name="current_password" 
                                       id="current_password" 
                                       required
                                       class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>

                        <!-- Nova Senha -->
                        <div>
                            <label for="new_password1" class="block text-sm font-medium text-gray-700">
                                Nova Senha
                            </label>
                            <div class="mt-1">
                                <input type="password" 
                                       name="new_password1" 
                                       id="new_password1" 
                                       required
                                       class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>

                        <!-- Confirmar Nova Senha -->
                        <div>
                            <label for="new_password2" class="block text-sm font-medium text-gray-700">
                                Confirmar Nova Senha
                            </label>
                            <div class="mt-1">
                                <input type="password" 
                                       name="new_password2" 
                                       id="new_password2" 
                                       required
                                       class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                    </div>

                    <!-- Botão -->
                    <div class="flex justify-end">
                        <button type="submit" 
                                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            Alterar Senha
                        </button>
                    </div>
                </form>
            </div>

            <!-- Excluir Conta -->
            <div class="border-t border-gray-200 mt-8 pt-8 px-6 pb-6">
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        Excluir Conta
                    </h3>
                    <p class="text-sm text-gray-500">
                        Uma vez que você excluir sua conta, não há volta. Por favor, tenha certeza.
                    </p>
                    <div class="flex justify-start">
                        <button type="button" 
                                id="delete-account"
                                class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <i class="fas fa-trash-alt mr-2"></i>
                            Excluir minha conta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div id="delete-modal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Excluir conta
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Você tem certeza que deseja excluir sua conta? Esta ação não pode ser desfeita. Todos os seus dados serão permanentemente removidos de nossos servidores para sempre. Esta ação não pode ser desfeita.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirm-delete" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Excluir
                </button>
                <button type="button" id="cancel-delete" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Preview da imagem do perfil
    const profileImageInput = document.getElementById('profile_image');
    const profileImagePreview = document.querySelector('img') || document.querySelector('span');
    const removeImageBtn = document.getElementById('remove_image');

    profileImageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if (profileImagePreview.tagName === 'SPAN') {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('h-16', 'w-16', 'rounded-full');
                    img.alt = 'Foto do Perfil';
                    profileImagePreview.parentNode.replaceChild(img, profileImagePreview);
                } else {
                    profileImagePreview.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }
    });

    removeImageBtn.addEventListener('click', () => {
        profileImageInput.value = '';
        if (profileImagePreview.tagName === 'IMG') {
            const span = document.createElement('span');
            span.classList.add('h-16', 'w-16', 'rounded-full', 'overflow-hidden', 'bg-gray-100', 'flex', 'items-center', 'justify-center');
            span.innerHTML = '<i class="fas fa-user text-3xl text-gray-400"></i>';
            profileImagePreview.parentNode.replaceChild(span, profileImagePreview);
        }
    });

    // Validação de senha
    const newPassword1 = document.getElementById('new_password1');
    const newPassword2 = document.getElementById('new_password2');
    const passwordForm = newPassword1.closest('form');

    newPassword1.addEventListener('input', () => {
        const value = newPassword1.value;
        const hasUpperCase = /[A-Z]/.test(value);
        const hasLowerCase = /[a-z]/.test(value);
        const hasNumbers = /\d/.test(value);
        const hasSpecialChars = /[!@#$%^&*(),.?":{}|<>]/.test(value);
        const isLongEnough = value.length >= 8;
        
        if (!isLongEnough || !hasUpperCase || !hasLowerCase || !hasNumbers || !hasSpecialChars) {
            newPassword1.setCustomValidity('A senha deve ter pelo menos 8 caracteres, incluindo maiúsculas, minúsculas, números e caracteres especiais.');
        } else {
            newPassword1.setCustomValidity('');
        }
    });

    newPassword2.addEventListener('input', () => {
        if (newPassword2.value !== newPassword1.value) {
            newPassword2.setCustomValidity('As senhas não conferem');
        } else {
            newPassword2.setCustomValidity('');
        }
    });

    // Modal de confirmação de exclusão
    const deleteModal = document.getElementById('delete-modal');
    const deleteBtn = document.getElementById('delete-account');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    const cancelDeleteBtn = document.getElementById('cancel-delete');

    deleteBtn.addEventListener('click', () => {
        deleteModal.classList.remove('hidden');
    });

    const hideModal = () => {
        deleteModal.classList.add('hidden');
    };

    cancelDeleteBtn.addEventListener('click', hideModal);
    deleteModal.addEventListener('click', (e) => {
        if (e.target === deleteModal) hideModal();
    });

    confirmDeleteBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('{% url "users:delete_account" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (response.ok) {
                window.location.href = '/';
            } else {
                const data = await response.json();
                showNotification(data.message || 'Erro ao excluir conta.', 'error');
            }
        } catch (error) {
            console.error('Erro ao excluir conta:', error);
            showNotification('Erro ao excluir conta. Tente novamente.', 'error');
        }
    });

    // Formulário principal
    const mainForm = document.querySelector('form');
    mainForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitButton = mainForm.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
        
        try {
            const formData = new FormData(mainForm);
            const response = await fetch(mainForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showNotification('Perfil atualizado com sucesso!', 'success');
                if (data.redirect) {
                    window.location.href = data.redirect;
                }
            } else {
                const errors = data.errors || {};
                Object.keys(errors).forEach(field => {
                    const input = mainForm.querySelector(`[name="${field}"]`);
                    if (input) {
                        input.setCustomValidity(errors[field].join(' '));
                        input.reportValidity();
                    }
                });
                showNotification(data.message || 'Erro ao atualizar perfil. Verifique os dados informados.', 'error');
            }
        } catch (error) {
            console.error('Erro ao atualizar perfil:', error);
            showNotification('Erro ao atualizar perfil. Tente novamente.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
        }
    });
});
</script>
{% endblock %}